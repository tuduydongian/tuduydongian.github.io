<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Ansible - tips and tricks | Tư Duy Đơn Giản</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Vài tips và trick nhỏ nhỏ để tăng độ sướng khi dùng ansible">
<meta name="keywords" content="tips,ansible">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible - tips and tricks">
<meta property="og:url" content="https://tuduydongian.com/2017/05/ansible-tips-and-trick/index.html">
<meta property="og:site_name" content="Tư Duy Đơn Giản">
<meta property="og:description" content="Vài tips và trick nhỏ nhỏ để tăng độ sướng khi dùng ansible">
<meta property="og:updated_time" content="2017-07-31T16:54:12.374Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible - tips and tricks">
<meta name="twitter:description" content="Vài tips và trick nhỏ nhỏ để tăng độ sướng khi dùng ansible">
<meta name="twitter:creator" content="@tuduydongian">
<meta property="fb:admins" content="100000290423290">
<meta property="fb:app_id" content="124307384811590">
  
    <link rel="alternate" href="/atom.xml" title="Tư Duy Đơn Giản" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-100038903-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  
<!-- Facebook SDK -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.9&appId=124307384811590";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<!-- End Facebook SDK -->


  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tư Duy Đơn Giản</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Nghĩ đơn giản, làm đơn giản</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://tuduydongian.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2017/05/ansible-tips-and-trick" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/ansible-tips-and-trick/" class="article-date">
  <time datetime="2017-05-28T17:00:00.000Z" itemprop="datePublished">2017-05-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/devops/">devops</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Ansible - tips and tricks
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Vài tips và trick nhỏ nhỏ để tăng độ sướng khi dùng ansible<br><a id="more"></a></p>
<h3 id="Deal-with-known-hosts"><a href="#Deal-with-known-hosts" class="headerlink" title="Deal with known hosts"></a>Deal with known hosts</h3><p>Thỉnh thoảng anh em sẽ thấy vài task ansible (ví dụ clone git, rsync…) đứng hình. Đơn giản là nó đòi xác thực cái server đang connect đến.<br>Có option trong ansible để disable check known host nhưng có 1 cách đơn giản hơn là làm 1 cái task, server nào của mình thì tự fetch và add known host vào. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">tasks:</span> </div><div class="line"><span class="attr">  - known_hosts:</span> <span class="string">path=/home/user/.ssh/known_hosts</span> <span class="string">name='my.server.com'</span> <span class="string">key="&#123;&#123;</span> <span class="string">lookup('pipe',</span> <span class="string">'ssh-keyscan -t rsa my.server.com'</span><span class="string">)</span> <span class="string">&#125;&#125;"</span></div></pre></td></tr></table></figure>
<h3 id="Deal-with-vault"><a href="#Deal-with-vault" class="headerlink" title="Deal with vault"></a>Deal with vault</h3><p>Thường thường thì một project sẽ có nhiều secret key và mình không nên commit vào trong code. Để giấu nó đi thì ta dùng vault.<br>Tuy nhiên hơi khoai tí là file vault thì toàn bộ mã hoá và mỗi lần mở vault ra hơi mệt. Có 1 rule khá đơn giản, ví dụ bạn cần mã hoá<br>biến mysql_db_password thì bạn sẽ đặt 1 biến tương ứng trong file vault là: vault_mysql_db_password.<br>Cấu trúc thư mục sẽ như sau:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-- group_vars </div><div class="line">---- all  </div><div class="line">------ all.yml </div><div class="line">------ vault.yml</div></pre></td></tr></table></figure></p>
<p>Trong file all.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">mysql_db_password:</span> <span class="string">"<span class="template-variable">&#123;&#123; vault_mysql_db_password &#125;&#125;</span>"</span></div></pre></td></tr></table></figure></p>
<p>Trong file vault.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">vault_mysql_db_password:</span> <span class="string">rat_dai_va_rat_kho_nho</span></div></pre></td></tr></table></figure></p>
<h3 id="Multiple-environment"><a href="#Multiple-environment" class="headerlink" title="Multiple environment"></a>Multiple environment</h3><p>Có nhiều cách để setup multiple environement trong ansible. Và mình thường follow theo cách đặt tên inventory trùng với environment.<br>Ví dụ bạn có 2 environment là: prod và dev<br>Cấu trúc thư mục:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># inventory  </div><div class="line">-- prod </div><div class="line">-- dev</div><div class="line">-- group_vars  </div><div class="line">---- all.yml # các biến dùng chung </div><div class="line">---- prod # các biến cho prod env </div><div class="line">------ prod.yml </div><div class="line">------ vault.yml </div><div class="line">---- dev # các biến cho dev env </div><div class="line">------ dev.yml </div><div class="line">------ vault.yml</div></pre></td></tr></table></figure></p>
<p>Nội dung của file inventory sẽ cần có thêm env, ví dụ cho prod:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[db]</div><div class="line">192.168.1.3</div><div class="line">[prod:children]</div><div class="line">db </div><div class="line">[prod:vars]</div><div class="line">ansible_python_interpreter=/usr/bin/python2.7</div></pre></td></tr></table></figure></p>
<p>Để chạy 1 playbook cho prod environment:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i prod dbserver.yml</div></pre></td></tr></table></figure></p>
<h3 id="SSH-Bastion-Host"><a href="#SSH-Bastion-Host" class="headerlink" title="SSH Bastion Host"></a>SSH Bastion Host</h3><p>Nếu infrastructure của bạn nằm toàn bộ trong private và vẫn muốn bảo mật như vậy nếu chạy ansible thì sẽ cần xài SSH bastion host.<br>Ý tưởng là mình sẽ có 1 cháu server làm vai trò bastion host. Toàn bộ các cháu trong private sẽ cho cháu này kết nối qua ssh. Và chỉ riêng mình cháu này có kết nối mạng với bên ngoài.<br>Làm cách này thì bạn sẽ yên tâm là không bao giờ ssh trực tiếp được vào production và gõ nhầm command (dại khái như rm -rf /).<br>Để làm cái này thì cấu hình ansible của bạn sẽ cần thêm 2 files: ssh.cfg và ansible.cfg<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># ansible.cfg</div><div class="line">[ssh_connection]</div><div class="line">ssh_args = -F ssh.cfg</div><div class="line">control_path = ~/.ssh/mux-%r@%h:%p</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># ssh.cfg</div><div class="line">Host 192.168.1.*</div><div class="line">  ProxyCommand           ssh -W %h:%p user@bastion.host</div><div class="line"></div><div class="line">Host *</div><div class="line">  ControlMaster          auto</div><div class="line">  ControlPath            ~/.ssh/mux-%r@%h:%p</div><div class="line">  ControlPersist         15m</div></pre></td></tr></table></figure>
<p>Nếu anh em có prod và dev env nằm ở 2 private network khác nhau và setup env theo phương án ở phía trên thì có thể tweak ssh.cfg<br>cho từng bastion host khác nhau dựa vào dải ip được nhé<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># ssh.cfg</div><div class="line">Host 192.168.1.*</div><div class="line">  ProxyCommand           ssh -W %h:%p user@bastion.host</div><div class="line"></div><div class="line">Host 10.0.0.*</div><div class="line">  ProxyCommand           ssh -W %h:%p user@prod_bastion.host</div></pre></td></tr></table></figure></p>
<p>Gần 2 năm làm với ansible mình rút ra được chừng này. Khi nào nhớ ra thêm thì bổ sung tiếp.<br>Anh em có tips hoặc tricks nào hay ho nữa thì merge request nhé ;) </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tuduydongian.com/2017/05/ansible-tips-and-trick/" data-id="cj5sebm080000i91r21f5rb6t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/">ansible</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tips/">tips</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/06/use-custom-event-instead-generic-event/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Use Custom Event instead Generic Event
        
      </div>
    </a>
  
  
    <a href="/2017/05/git-cheat-sheet/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Git cheat sheet for beginer</div>
    </a>
  
</nav>

  
</article>



  <section id="comments">
  <div class="fb-comments" data-href="https://tuduydongian.com/2017/05/ansible-tips-and-trick/index.html" data-width="100%" data-numposts="10"></div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/">frontend</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js,</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/symfony/">symfony</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ansible/">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/best-practice/">best practice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bootstrap-native/">bootstrap-native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cheatsheet/">cheatsheet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tips/">tips</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/best-practice/" style="font-size: 20px;">best practice</a> <a href="/tags/bootstrap-native/" style="font-size: 10px;">bootstrap-native</a> <a href="/tags/cheatsheet/" style="font-size: 10px;">cheatsheet</a> <a href="/tags/git/" style="font-size: 20px;">git</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/tips/" style="font-size: 10px;">tips</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/07/customize-modal-bootrap-native/">Modal of Bootstrap</a>
          </li>
        
          <li>
            <a href="/2017/07/async-simple/">Async thật đơn giản</a>
          </li>
        
          <li>
            <a href="/2017/07/symfony-demo/">Vài thứ hay ho từ Symfony Demo</a>
          </li>
        
          <li>
            <a href="/2017/07/webpack-simple-2/">Webpack thật đơn giản phần 2</a>
          </li>
        
          <li>
            <a href="/2017/06/git-endless-story/">Git, những niềm đau</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 tuduydongian.com
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>